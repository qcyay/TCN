# ğŸ”§ TCN Delay å¤„ç†ä¿®å¤

## é—®é¢˜æè¿°

åœ¨TCNæ¨¡å‹ä¸­ï¼Œä¸åŒè¾“å‡ºé€šé“å¯èƒ½æœ‰ä¸åŒçš„ `model_delays` å€¼ã€‚åŸæ¥çš„ä»£ç åœ¨åº”ç”¨delayæ—¶ï¼Œä¼šå¯¼è‡´ä¸åŒé€šé“çš„åºåˆ—é•¿åº¦ä¸ä¸€è‡´ï¼Œä»è€Œæ— æ³•è¿›è¡Œ `torch.stack()` æ“ä½œã€‚

### åŸå§‹ä»£ç é—®é¢˜

```python
for j in range(num_outputs):
    est_j = est_trial[j]
    lbl_j = lbl_trial[j]
    
    if config.model_delays[j] != 0:
        est_j = est_j[config.model_delays[j]:]      # å»æ‰å‰delayä¸ª
        lbl_j = lbl_j[:-config.model_delays[j]]     # å»æ‰ådelayä¸ª
    
    est_shifted.append(est_j)
    lbl_shifted.append(lbl_j)

est_stacked = torch.stack(est_shifted)  # âŒ é”™è¯¯ï¼šé•¿åº¦ä¸ä¸€è‡´ï¼Œæ— æ³•stack
```

**ç¤ºä¾‹**ï¼š
- åŸå§‹é•¿åº¦ï¼š1000
- delays = [0, 5, 10]

åº”ç”¨delayåï¼š
- channel 0 (delay=0): é•¿åº¦ 1000
- channel 1 (delay=5): é•¿åº¦ 995
- channel 2 (delay=10): é•¿åº¦ 990

âŒ **æ— æ³•stackï¼**

## è§£å†³æ–¹æ¡ˆ

æ‰¾åˆ°æœ€å¤§delay (`max_delay`)ï¼Œæ‰€æœ‰é€šé“éƒ½åœ¨ç›¸åŒçš„æ—¶é—´èŒƒå›´å†…è¿›è¡Œè¯„ä¼°ã€‚

### æ ¸å¿ƒæ€æƒ³

1. **ç»Ÿä¸€æ—¶é—´èŒƒå›´**ï¼šæ‰€æœ‰é€šé“çš„æœ‰æ•ˆé•¿åº¦ = åŸå§‹é•¿åº¦ - max_delay
2. **å¯¹é½æ–¹å¼**ï¼š
   - é¢„æµ‹å€¼ï¼šæ‰€æœ‰é€šé“ä» `max_delay` ä½ç½®å¼€å§‹å–
   - æ ‡ç­¾ï¼šæ ¹æ®å„é€šé“çš„delayè¿›è¡Œç›¸åº”åç§»

### ä¿®å¤åçš„ä»£ç 

```python
# æ‰¾åˆ°æœ€å¤§delay
max_delay = max(config.model_delays)
valid_length = est_trial.size(1) - max_delay

if valid_length <= 0:
    # åºåˆ—å¤ªçŸ­ï¼Œè·³è¿‡
    continue

for j in range(num_outputs):
    delay = config.model_delays[j]
    
    # é¢„æµ‹å€¼ï¼šä»max_delayä½ç½®å¼€å§‹å–
    est_j = est_trial[j, max_delay:]
    
    # æ ‡ç­¾ï¼šæ ¹æ®å½“å‰é€šé“çš„delayè¿›è¡Œåç§»
    lbl_start = max_delay - delay
    lbl_end = lbl_start + valid_length
    lbl_j = lbl_trial[j, lbl_start:lbl_end]
    
    est_shifted.append(est_j)
    lbl_shifted.append(lbl_j)

est_stacked = torch.stack(est_shifted)  # âœ… æ­£ç¡®ï¼šæ‰€æœ‰é€šé“é•¿åº¦ä¸€è‡´
```

## ç¤ºä¾‹éªŒè¯

### è®¾ç½®
- åŸå§‹é•¿åº¦ï¼š1000
- delays = [0, 5, 10]
- max_delay = 10
- valid_length = 1000 - 10 = 990

### å„é€šé“å¤„ç†

#### Channel 0 (delay=0)
```python
est: est_trial[0, 10:]          # [10:1000], 990ä¸ªç‚¹
lbl: lbl_trial[0, 10:1000]      # [10:1000], 990ä¸ªç‚¹
```

#### Channel 1 (delay=5)
```python
est: est_trial[1, 10:]          # [10:1000], 990ä¸ªç‚¹
lbl: lbl_trial[1, 5:995]        # [5:995], 990ä¸ªç‚¹
```

#### Channel 2 (delay=10)
```python
est: est_trial[2, 10:]          # [10:1000], 990ä¸ªç‚¹
lbl: lbl_trial[2, 0:990]        # [0:990], 990ä¸ªç‚¹
```

âœ… **æ‰€æœ‰é€šé“é•¿åº¦ä¸€è‡´ï¼š990ä¸ªç‚¹**

### æ—¶é—´å¯¹é½éªŒè¯

æ‰€æœ‰é€šé“çš„é¢„æµ‹å€¼éƒ½å¯¹åº”ç›¸åŒçš„æ—¶é—´æ­¥ [10, 11, ..., 999]ï¼š

- **Channel 0**: 
  - `est[10]` å¯¹åº” `lbl[10]`ï¼ˆdelay=0ï¼‰
  
- **Channel 1**: 
  - `est[10]` å¯¹åº” `lbl[5]`ï¼ˆdelay=5ï¼Œæ¨¡å‹åœ¨t=10çš„è¾“å‡ºå¯¹åº”t=5çš„çœŸå®å€¼ï¼‰
  
- **Channel 2**: 
  - `est[10]` å¯¹åº” `lbl[0]`ï¼ˆdelay=10ï¼Œæ¨¡å‹åœ¨t=10çš„è¾“å‡ºå¯¹åº”t=0çš„çœŸå®å€¼ï¼‰

## ä¿®æ”¹çš„æ–‡ä»¶

### 1. train.py

#### ä½ç½®1ï¼švalidateå‡½æ•°ï¼ˆTCNéªŒè¯ï¼‰
- **è¡Œå·**: çº¦651-677
- **ä¿®æ”¹**: åº”ç”¨ç»Ÿä¸€çš„delayå¤„ç†é€»è¾‘
- **å½±å“**: éªŒè¯æ—¶æ‰€æœ‰é€šé“åœ¨ç›¸åŒæ—¶é—´èŒƒå›´å†…è¯„ä¼°

#### ä½ç½®2ï¼štrain_epochå‡½æ•°ï¼ˆTCNè®­ç»ƒï¼‰
- **è¡Œå·**: çº¦1140-1158
- **ä¿®æ”¹**: è®­ç»ƒæ—¶åº”ç”¨ç»Ÿä¸€çš„delayå¤„ç†é€»è¾‘
- **å½±å“**: è®­ç»ƒlossè®¡ç®—æ—¶æ‰€æœ‰é€šé“åœ¨ç›¸åŒæ—¶é—´èŒƒå›´å†…

### 2. test.py

#### ä½ç½®ï¼šTCNæµ‹è¯•ä¸»å¾ªç¯
- **è¡Œå·**: çº¦637-668
- **ä¿®æ”¹**: æµ‹è¯•æ—¶åº”ç”¨ç»Ÿä¸€çš„delayå¤„ç†é€»è¾‘
- **å½±å“**: æµ‹è¯•æŒ‡æ ‡è®¡ç®—æ—¶æ‰€æœ‰é€šé“åœ¨ç›¸åŒæ—¶é—´èŒƒå›´å†…è¯„ä¼°

## ä¼˜åŠ¿

### 1. **æ­£ç¡®æ€§** âœ…
- æ‰€æœ‰é€šé“é•¿åº¦ä¸€è‡´ï¼Œå¯ä»¥æ­£ç¡®stack
- æ‰€æœ‰é€šé“åœ¨ç›¸åŒçš„æ—¶é—´èŒƒå›´å†…è¯„ä¼°

### 2. **ä¸€è‡´æ€§** âœ…
- è®­ç»ƒã€éªŒè¯ã€æµ‹è¯•ä½¿ç”¨ç›¸åŒçš„delayå¤„ç†é€»è¾‘
- ç¡®ä¿è¯„ä¼°ç»“æœçš„å¯æ¯”æ€§

### 3. **é²æ£’æ€§** âœ…
- è‡ªåŠ¨å¤„ç†ä¸åŒdelayç»„åˆ
- åºåˆ—è¿‡çŸ­æ—¶è‡ªåŠ¨è·³è¿‡

### 4. **å¯ç†è§£æ€§** âœ…
- æ¸…æ™°çš„æ—¶é—´å¯¹é½é€»è¾‘
- æ˜“äºç»´æŠ¤å’Œè°ƒè¯•

## ä½¿ç”¨è¯´æ˜

### é…ç½®æ–‡ä»¶ä¸­è®¾ç½®delay

```python
# configs/partial_motion_knee_config.py
model_delays = [0, 5, 10, 15]  # ä¸ºæ¯ä¸ªè¾“å‡ºé€šé“æŒ‡å®šdelay
```

### è¿è¡Œæµ‹è¯•

```bash
# è®­ç»ƒ
python train.py --config_path configs.default_config --device 0

# æµ‹è¯•
python test.py --config_path configs.default_config \
               --model_path logs/model.tar \
               --device 0
```

## æ³¨æ„äº‹é¡¹

### 1. åºåˆ—é•¿åº¦è¦æ±‚
- ç¡®ä¿åºåˆ—é•¿åº¦ > max_delay
- å¦‚æœ `valid_length <= 0`ï¼Œè¯¥trialä¼šè¢«è·³è¿‡

### 2. Delayå€¼è®¾ç½®
- å»ºè®®delaysåœ¨åˆç†èŒƒå›´å†…ï¼ˆå¦‚0-20ï¼‰
- è¿‡å¤§çš„delayä¼šå¯¼è‡´æœ‰æ•ˆæ•°æ®ç‚¹å‡å°‘

### 3. è¯„ä¼°èŒƒå›´
- æ‰€æœ‰é€šé“åœ¨ [max_delay, sequence_length-1] èŒƒå›´å†…è¯„ä¼°
- æœ‰æ•ˆè¯„ä¼°é•¿åº¦ = sequence_length - max_delay

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1ï¼šç›¸åŒdelay
```python
model_delays = [5, 5, 5, 5]
max_delay = 5
# æ‰€æœ‰é€šé“é•¿åº¦ä¸€è‡´ âœ…
```

### æµ‹è¯•åœºæ™¯2ï¼šä¸åŒdelay
```python
model_delays = [0, 5, 10, 15]
max_delay = 15
# æ‰€æœ‰é€šé“é•¿åº¦ä¸€è‡´ âœ…
```

### æµ‹è¯•åœºæ™¯3ï¼šéƒ¨åˆ†é›¶delay
```python
model_delays = [0, 0, 10, 10]
max_delay = 10
# æ‰€æœ‰é€šé“é•¿åº¦ä¸€è‡´ âœ…
```

## æ€§èƒ½å½±å“

- **è®¡ç®—å¼€é”€**: å‡ ä¹æ²¡æœ‰å¢åŠ ï¼ˆåªæ˜¯ç´¢å¼•æ“ä½œï¼‰
- **å†…å­˜å ç”¨**: æ— å˜åŒ–
- **è®­ç»ƒé€Ÿåº¦**: æ— å½±å“
- **å‡†ç¡®æ€§**: âœ… æé«˜ï¼ˆæ­£ç¡®çš„æ—¶é—´å¯¹é½ï¼‰

## å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å…¼å®¹**

- å¯¹äºæ‰€æœ‰delayç›¸åŒçš„æƒ…å†µï¼Œç»“æœå®Œå…¨ä¸€è‡´
- å¯¹äºdelayä¸åŒçš„æƒ…å†µï¼Œä¿®å¤äº†åŸæœ‰çš„bug
- ä¸éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶æˆ–æ•°æ®æ ¼å¼

## æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº†TCNæ¨¡å‹ä¸­ä¸åŒé€šé“delayä¸åŒæ—¶çš„é•¿åº¦ä¸ä¸€è‡´é—®é¢˜ï¼Œç¡®ä¿ï¼š

1. âœ… æ‰€æœ‰é€šé“å¯ä»¥æ­£ç¡®stack
2. âœ… æ‰€æœ‰é€šé“åœ¨ç›¸åŒæ—¶é—´èŒƒå›´å†…è¯„ä¼°
3. âœ… æ—¶é—´å¯¹é½æ­£ç¡®
4. âœ… è®­ç»ƒã€éªŒè¯ã€æµ‹è¯•é€»è¾‘ä¸€è‡´
5. âœ… ä»£ç æ›´åŠ å¥å£®å’Œæ˜“ç»´æŠ¤

---

**ä¿®å¤æ—¥æœŸ**: 2025-10-28  
**ç‰ˆæœ¬**: v3.2 (Delayå¤„ç†ä¿®å¤)  
**å½±å“æ–‡ä»¶**: train.py, test.py  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•