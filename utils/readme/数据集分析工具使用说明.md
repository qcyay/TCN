# 数据集分析工具使用说明

## 概述

`analyze_dataset.py` 是一个用于分析和统计TCN项目数据集内容的工具。它可以帮助你快速了解训练集和测试集的组成，识别数据分布差异，并发现潜在的数据问题。

## 功能特性

1. **统计运动形式和类型**
   - 自动识别数据集中的所有运动形式（如 ball_toss, normal_walk 等）
   - 列出每种运动形式下的所有类型/条件（如 on, off, center_off 等）
   - 统计每个类型下的参与者数量

2. **数据集对比分析**
   - 比较训练集和测试集的运动形式分布
   - 识别仅存在于训练集或测试集中的运动类型
   - **重点突出显示测试集中独有的运动模式**（这可能导致模型泛化问题）

3. **统计摘要**
   - 显示运动形式、类型和试验的总数
   - 提供训练集和测试集的对比统计

## 安装要求

无需额外安装，仅使用Python标准库。

## 使用方法

### 基本用法

在TCN项目根目录下运行：

```bash
# 使用默认数据目录 (data/)，只在屏幕显示
python utils/analyze_dataset.py

# 指定自定义数据目录
python utils/analyze_dataset.py --data_dir data/example

# 保存结果到文件（同时在屏幕显示）
python utils/analyze_dataset.py --output logs/dataset_analysis.txt

# 完整用法：指定数据目录、显示详细信息并保存到文件
python utils/analyze_dataset.py --data_dir data/full_dataset --verbose --output analysis_result.txt
```

### 参数说明

- `--data_dir`: 指定数据根目录路径（默认: `data`）
- `--output`: 指定输出文件路径。如果指定，分析结果将同时显示在屏幕上并保存到文件中（例如: `logs/dataset_analysis.txt`）
- `--verbose`: 显示详细的统计信息，包括每个运动形式和类型的参与者列表

### 输出说明

工具会输出以下几个部分的信息：

#### 1. 整体统计摘要
```
指标                           TRAIN           TEST           总计
---------------------------------------------------------------------------
运动形式数量                      15             12             27
运动类型数量                      45             38             83
试验数量                        234            189            423
```

#### 2. 运动形式对比
- 共同的运动形式：在训练集和测试集中都存在
- 仅在TRAIN中的运动形式：只在训练集中存在
- 仅在TEST中的运动形式：只在测试集中存在（**需要特别关注**）

#### 3. 各运动形式的类型对比
针对每个运动形式，显示：
- 共同类型：训练集和测试集都有
- 仅TRAIN有：只在训练集中存在
- 仅TEST有：只在测试集中存在（**需要特别关注**）

#### 4. 运动模式文件夹名称对比
完整的文件夹名称对比，包括：
- 共同的运动模式文件夹
- 仅在TRAIN中的文件夹
- **⚠️ 仅在TEST中的文件夹**（重点标注）

对于测试集独有的文件夹，工具会自动解析其运动形式和类型，便于理解。

## 运动模式命名规则

数据集中的运动模式文件夹通常遵循以下命名格式：

```
{运动形式}_{参数}_{类型}
```

例如：
- `ball_toss_1_2_center_off` 
  - 运动形式: ball_toss
  - 参数: 1_2_center
  - 类型: off

- `normal_walk_3_2-0_off`
  - 运动形式: normal_walk
  - 参数: 3_2-0
  - 类型: off

- `stair_ascent_1_on`
  - 运动形式: stair_ascent
  - 参数: 1
  - 类型: on

工具会自动解析这些命名模式。

## 使用场景

### 场景 1: 检查数据集完整性

在开始训练前运行此工具，确保：
- 训练集和测试集的运动形式分布合理
- 没有测试集独有的运动类型（可能导致泛化问题）

```bash
# 分析并保存结果
python utils/analyze_dataset.py --data_dir data/full_dataset --output logs/dataset_check.txt
```

### 场景 2: 调试数据加载问题

如果数据加载出现问题，使用详细模式检查：

```bash
# 显示详细信息并保存
python utils/analyze_dataset.py --verbose --output logs/detailed_analysis.txt
```

这会显示每个参与者在各运动类型下的分布。

### 场景 3: 准备论文/报告的数据统计

工具输出可以直接用于报告中的数据集描述部分。

```bash
# 生成用于论文的数据集统计
python utils/analyze_dataset.py --output paper_dataset_stats.txt
```

## 输出文件

当使用 `--output` 参数时：
- 分析结果会**同时**显示在屏幕上并保存到指定的文件中
- 输出文件包含完整的分析结果，包括时间戳
- 如果输出目录不存在，会自动创建
- 文件采用UTF-8编码，确保中文正常显示

推荐的输出文件位置：
- `logs/dataset_analysis.txt` - 常规分析
- `logs/dataset_analysis_详细.txt` - 详细分析（使用--verbose时）
- `logs/dataset_analysis_YYYYMMDD.txt` - 带日期的分析记录

## 注意事项

1. **测试集独有的运动模式**：工具会特别标注这些情况。如果测试集中包含训练集没有的运动类型，模型可能在这些类型上表现不佳。

2. **文件夹结构要求**：工具假设数据按以下结构组织：
   ```
   data_dir/
   ├── train/
   │   ├── 参与者1/
   │   │   ├── 运动模式1/
   │   │   └── 运动模式2/
   │   └── 参与者2/
   └── test/
       ├── 参与者3/
       └── 参与者4/
   ```

3. **命名解析**：工具使用启发式方法解析运动模式名称。如果你的命名格式与示例差异较大，可能需要修改 `parse_activity_folder()` 函数。

## 输出示例

```
████████████████████████████████████████████████████████████████████████████████
                          TCN 数据集分析工具
████████████████████████████████████████████████████████████████████████████████
数据目录: data/example

正在扫描数据集...

================================================================================
                              整体统计摘要
================================================================================

指标                           TRAIN           TEST           总计
---------------------------------------------------------------------------
运动形式数量                       8             10             18
运动类型数量                      24             28             52
试验数量                        156            123            279

================================================================================
                            数据集对比分析
================================================================================

【运动形式对比】
  共同的运动形式: 8
    ball_toss, normal_walk, sit_to_stand, squat, stair_ascent, ...

  仅在TRAIN中的运动形式: 0

  仅在TEST中的运动形式: 2
    balance_test, jump_landing

────────────────────────────────────────────────────────────────────────────────
【各运动形式的类型对比】
────────────────────────────────────────────────────────────────────────────────

运动形式: ball_toss
  共同类型: center_off, left_off, right_off
  仅TEST有: center_on

...

⚠️  仅在TEST中的运动模式文件夹: 3
  • balance_test_1_off
    └─ 解析为: 运动形式='balance_test', 类型='off'
  • jump_landing_2_on
    └─ 解析为: 运动形式='jump_landing', 类型='on'
  • normal_walk_4_center_on
    └─ 解析为: 运动形式='normal_walk', 类型='center_on'

================================================================================
分析完成!
================================================================================
```

## 故障排除

### 问题：找不到数据

**错误信息**：`错误: 数据目录不存在`

**解决方案**：
- 检查数据目录路径是否正确
- 使用 `--data_dir` 参数指定正确的路径

### 问题：未找到任何数据

**错误信息**：`错误: 未找到任何数据`

**解决方案**：
- 确保数据目录下包含 `train` 和/或 `test` 子目录
- 检查子目录中是否有参与者文件夹
- 确认文件夹结构符合要求

## 扩展和自定义

如果需要修改运动模式的解析逻辑，编辑 `parse_activity_folder()` 函数：

```python
def parse_activity_folder(folder_name: str) -> Tuple[str, str]:
    """
    自定义解析逻辑
    """
    # 你的解析代码
    pass
```

## 相关文件

- `dataset_loaders/dataloader.py`: 数据加载器
- `configs/TCN/default_config.py`: 配置文件
- `train.py`: 训练脚本
- `test.py`: 测试脚本