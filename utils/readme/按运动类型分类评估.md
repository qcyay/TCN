# 力矩预测项目 - 按运动类型分类评估更新

## 更新概述

本次更新为test.py添加了按运动类型分类评估和可视化功能，可以：
1. 将28种运动类型自动分为三大类：**周期性运动**、**阻抗性运动**和**非结构化运动**
2. 对每类任务分别计算RMSE、R²和归一化MAE指标
3. 单独评估9个训练集中未见过的任务
4. 生成分面箱线图（faceted boxplot）展示各类任务的性能
5. 支持自定义额外的运动类型分组并生成对应的箱线图

## 修改的文件

### 1. default_config.py

新增配置项：

```python
# ==================== 运动类型分类配置 ====================

# 运动类型到大类的映射（用于test.py分类评估）
action_to_category = {
    # 周期性运动 (Cyclic)
    r"^normal_walk_.*_(shuffle|0-6|1-2|1-8).*": "Cyclic",  # Level ground walk
    r"^walk_backward_.*": "Cyclic",  # Backwards walk
    # ... 其他映射
    
    # 阻抗性运动 (Impedance-like)
    r"^poses_.*": "Impedance-like",  # Standing poses
    # ... 其他映射
    
    # 非结构化运动 (Unstructured)
    r"^dynamic_walk_.*(high-knees|butt-kicks).*": "Unstructured",  # Calisthenics
    # ... 其他映射
}

# 训练集中未见过的任务
unseen_action_patterns = [
    r"^lunges_.*",  # Lunge
    r"^stairs_.*up.*",  # Stair ascent
    # ... 共9个任务
]

# ==================== 可视化配置 ====================

# 是否生成箱线图
generate_boxplots = True

# 是否为三大类别生成箱线图
plot_categories = True

# 是否为未见任务生成箱线图
plot_unseen = True

# 额外需要绘制的运动类型分组
additional_plot_groups = [
    # 示例：只看行走类任务
    # {
    #     'name': 'Walking Tasks',
    #     'patterns': [
    #         r"^normal_walk_.*_(shuffle|0-6|1-2|1-8).*",
    #         r"^walk_backward_.*",
    #     ]
    # },
]
```

### 2. test.py

**新增功能：**

1. **运动类型分类函数**
   - `categorize_trial()`: 根据trial名称判断所属类别
   - `check_unseen_task()`: 判断是否为未见过的任务

2. **按类别计算指标**
   - `compute_category_metrics()`: 计算各类别的指标，每个序列单独计算后取平均
   - 支持同时统计：All、Cyclic、Impedance-like、Unstructured、Unseen

3. **结果展示**
   - `print_category_results()`: 在控制台打印各类别的统计结果
   - `save_metrics_to_file()`: 将结果保存到txt文件

4. **箱线图可视化**
   - `create_boxplots()`: 创建分面箱线图
   - 箱线图特点：
     * 箱内横线为中位数
     * 黑色小方块为均值
     * 支持多类别对比
     * R²指标使用灰色背景区分

## 运动类型分类详情

### 周期性运动 (Cyclic) - 9种
1. Level ground walk - 平地行走
2. Backwards walk - 后退行走
3. 25 lb Loaded walk - 负重行走
4. Run - 跑步
5. Toe and heel walk - 脚尖和脚跟行走
6. Inclined walk - 上坡行走
7. Stair descent - 下楼梯
8. Stair ascent - 上楼梯
9. Declined walk - 下坡行走

### 阻抗性运动 (Impedance-like) - 10种
1. Standing poses - 站立姿势
2. Jump in place - 原地跳跃
3. Sit and stand - 坐站转换
4. Lift and place weight - 举重物
5. Tug of war - 拔河
6. Jump across - 横向跳跃
7. Lunge - 弓步
8. Medicine ball toss - 药球投掷
9. Squat - 深蹲
10. Step up - 台阶上升

### 非结构化运动 (Unstructured) - 9种
1. Calisthenics - 健美操
2. Push and pull recovery - 推拉恢复
3. Turns - 转身
4. Cut - 急转
5. Twister - 扭腰运动
6. Meander - 蜿蜒行走
7. Start and stop - 启停运动
8. Step over - 跨越障碍
9. Curb - 路缘石

### 未见任务 (Unseen) - 9种
训练集中未见过的任务，用于评估模型泛化能力：
1. Lunge - 弓步
2. Stair ascent - 上楼梯
3. Declined walk - 下坡行走
4. Start and stop - 启停运动
5. Medicine ball toss - 药球投掷
6. Step over - 跨越障碍
7. Squat - 深蹲
8. Curb - 路缘石
9. Step up - 台阶上升

## 使用方法

### 1. 基本测试（自动生成所有箱线图）

```bash
python test.py --config_path configs.default_config --model_path logs/trained_model.tar
```

### 2. 自定义可视化

在`default_config.py`中修改：

```python
# 只生成三大类别的箱线图，不生成未见任务的图
plot_categories = True
plot_unseen = False

# 添加自定义分组
additional_plot_groups = [
    {
        'name': 'Walking Tasks',
        'patterns': [
            r"^normal_walk_.*_(shuffle|0-6|1-2|1-8).*",
            r"^walk_backward_.*",
            r"^weighted_walk_.*",
        ]
    },
    {
        'name': 'Jumping Tasks',
        'patterns': [
            r"^jump_.*",
        ]
    },
]
```

### 3. 完全禁用箱线图

```python
generate_boxplots = False
```

## 输出文件

测试完成后，会在模型所在目录生成以下文件：

1. **test_results_by_category.txt**
   - 各类别的详细统计结果
   - 包含均值、标准差和样本数量

2. **箱线图PNG文件**
   - `boxplot_hip_flexion_r_moment_Cyclic-Impedance-like-Unstructured.png`
   - `boxplot_knee_angle_r_moment_Cyclic-Impedance-like-Unstructured.png`
   - `boxplot_hip_flexion_r_moment_All_vs_Unseen.png`
   - `boxplot_knee_angle_r_moment_All_vs_Unseen.png`
   - 以及自定义分组的箱线图

## 指标说明

对于每个类别，分别计算三个指标：

1. **RMSE (Root Mean Square Error)**
   - 单位：Nm/kg
   - 均方根误差，越小越好

2. **R² (Coefficient of Determination)**
   - 范围：-∞ 到 1
   - 决定系数，越接近1越好

3. **Normalized MAE (Mean Absolute Error)**
   - 单位：百分比 (%)
   - 使用该序列标签的最大值和最小值的差进行归一化
   - 越小越好

## 计算方法

1. **序列级别计算**
   - 对测试集中的每个文件序列分别计算三个指标
   - 每个序列产生一组 (RMSE, R², MAE) 值

2. **类别级别聚合**
   - 将属于同一类别的所有序列的指标值收集起来
   - 计算均值作为该类别的最终指标
   - 这样可以保证每个序列在统计中的权重相同

## 箱线图说明

箱线图的组成元素：
- **箱体**：蓝色填充，表示四分位距 (IQR)
- **箱内横线**：黑色粗线，表示中位数
- **黑色方块**：表示均值
- **须**：黑色竖线，表示数据分布范围
- **离群点**：灰色圆点

特殊设计：
- R²指标的子图使用灰色背景，便于区分
- 支持星号标注显著性差异（如需要可在代码中添加）

## 示例输出

```
【All】
--------------------------------------------------------------------------------

  hip_flexion_r_moment:
    RMSE: 0.1234 Nm/kg (n=150)
    R²: 0.8765 (n=150)
    MAE: 12.34% (n=150)

  knee_angle_r_moment:
    RMSE: 0.2345 Nm/kg (n=150)
    R²: 0.7654 (n=150)
    MAE: 15.67% (n=150)

【Cyclic】
--------------------------------------------------------------------------------

  hip_flexion_r_moment:
    RMSE: 0.1100 Nm/kg (n=80)
    R²: 0.9100 (n=80)
    MAE: 10.50% (n=80)
    
... (更多类别)
```

## 注意事项

1. **action_to_category映射**
   - 确保正则表达式能正确匹配数据文件名
   - 如果某个trial未被匹配，会归类到"Unknown"

2. **未见任务**
   - unseen_action_patterns中的任务也会被归类到三大类别之一
   - 它们在"Unseen"类别中会被单独统计

3. **箱线图生成**
   - 需要matplotlib库
   - 图片保存为300 DPI的PNG格式，适合论文使用

4. **性能考虑**
   - 对于大数据集，计算和可视化可能需要一些时间
   - 可以通过设置`generate_boxplots = False`跳过可视化

## 扩展建议

如果需要添加更多功能，可以考虑：

1. **统计检验**
   - 在箱线图上添加显著性检验结果（t-test, ANOVA等）
   - 添加星号标注显著性水平

2. **更多可视化**
   - 散点图：每个任务的R²对比
   - 热力图：各任务的性能矩阵
   - 误差随时间的变化曲线

3. **详细报告**
   - 生成HTML格式的交互式报告
   - 包含所有图表和详细统计

## 技术细节

### 类别判定逻辑

```python
def categorize_trial(trial_name: str, action_to_category: Dict[str, str]) -> str:
    # 提取运动类型部分
    action_name = trial_name.split("/")[-1].split("\\")[-1]
    
    # 尝试匹配每个正则表达式
    for pattern, category in action_to_category.items():
        if re.match(pattern, action_name):
            return category
    
    return "Unknown"
```

### 指标计算

每个序列独立计算指标，然后对同类别的所有序列取平均：

```python
# 对每个序列计算
for est_seq, lbl_seq in zip(estimates_list, labels_list):
    metrics = compute_metrics_per_sequence(est_seq, lbl_seq)
    category_metrics[category][label_name]['rmse'].append(metrics['rmse'])
    
# 最后求平均
mean_rmse = sum(metrics['rmse']) / len(metrics['rmse'])
```

## 常见问题

**Q: 为什么有些类别没有数据？**
A: 检查test数据集中是否包含该类别的文件，以及action_patterns是否正确筛选。

**Q: 箱线图中的离群点是什么？**
A: 离群点表示某些序列的指标值与该类别的整体分布有较大偏差，这是正常现象。

**Q: 如何调整箱线图的样式？**
A: 修改`create_boxplots()`函数中的matplotlib参数，如颜色、线宽、字体大小等。

**Q: Unseen类别的结果如何解释？**
A: Unseen类别反映模型在训练时未见过的任务上的泛化能力。如果Unseen的性能显著低于整体，说明模型可能存在过拟合。

## 更新日志

### Version 2.0 (当前版本)
- ✅ 添加运动类型分类评估功能
- ✅ 实现分面箱线图可视化
- ✅ 支持未见任务单独评估
- ✅ 支持自定义运动类型分组
- ✅ 结果保存到文本文件
- ✅ 完善的配置选项

### Version 1.0
- 基本的测试功能
- 整体指标计算
- 简单的结果打印

## 联系与支持

如有问题或建议，请参考项目文档或联系开发团队。