# ä¸ºä»€ä¹ˆå¼€å¤´çš„NaNå¯¼è‡´tensorå½¢çŠ¶ä¸º[1, 25, 0]ï¼Ÿ

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**æ—§ä»£ç çš„å‡è®¾**ï¼šNaNåªä¼šå‡ºç°åœ¨æ–‡ä»¶æœ«å°¾  
**å®é™…æƒ…å†µ**ï¼šNaNä¹Ÿä¼šå‡ºç°åœ¨æ–‡ä»¶å¼€å¤´  
**ç»“æœ**ï¼šé€»è¾‘å®Œå…¨å¤±æ•ˆï¼Œå¯¼è‡´æå–çš„æ•°æ®ä¸ºç©º

## ğŸ“Š å…·ä½“ä¾‹å­

### åŸå§‹CSVæ–‡ä»¶ï¼ˆ15è¡Œï¼‰

```
è¡Œå· | æ•°æ®çŠ¶æ€        | è¯´æ˜
-----|----------------|------------------
0    | NaN NaN NaN... | å¼€å¤´çš„åæ•°æ®
1    | NaN NaN NaN... | å¼€å¤´çš„åæ•°æ®
2    | NaN NaN NaN... | å¼€å¤´çš„åæ•°æ®  
3    | NaN NaN NaN... | å¼€å¤´çš„åæ•°æ®
4    | NaN NaN NaN... | å¼€å¤´çš„åæ•°æ®
5    | 1.2 3.4 5.6... | â† ä»è¿™é‡Œå¼€å§‹æ˜¯æœ‰æ•ˆæ•°æ®
6    | 2.3 4.5 6.7... | æœ‰æ•ˆæ•°æ®
7    | 3.4 5.6 7.8... | æœ‰æ•ˆæ•°æ®
8    | 4.5 6.7 8.9... | æœ‰æ•ˆæ•°æ®
9    | 5.6 7.8 9.0... | æœ‰æ•ˆæ•°æ®
10   | 6.7 8.9 0.1... | æœ‰æ•ˆæ•°æ®
11   | 7.8 9.0 1.2... | æœ‰æ•ˆæ•°æ®
12   | 8.9 0.1 2.3... | æœ‰æ•ˆæ•°æ®
13   | NaN NaN NaN... | æœ«å°¾çš„åæ•°æ®
14   | NaN NaN NaN... | æœ«å°¾çš„åæ•°æ®
```

## ğŸ”´ æ—§æ–¹æ³•çš„å¤„ç†ï¼ˆ_find_nan_cutoffï¼‰

### æ­¥éª¤1ï¼šæ£€æµ‹ç¬¬ä¸€ä¸ªNaN

```python
def _find_nan_cutoff(df, columns):
    nan_mask = df[columns].isna().any(axis=1)
    # nan_mask = [True, True, True, True, True, False, ..., False, True, True]
    #             è¡Œ0-4           è¡Œ5-12           è¡Œ13-14
    
    nan_indices = [0, 1, 2, 3, 4, 13, 14]  # æ‰€æœ‰å«NaNçš„è¡Œ
    
    return nan_indices[0]  # è¿”å›ç¬¬ä¸€ä¸ª = 0
```

### æ­¥éª¤2ï¼šæˆªæ–­æ•°æ®

```python
cutoff_index = 0  # ä»ä¸Šä¸€æ­¥å¾—åˆ°

df = df.iloc[:0]  # df.iloc[:0] è¡¨ç¤º"å–å‰0è¡Œ"

print(df.shape)
# è¾“å‡º: (0, 71)  â† ç©ºDataFrameï¼ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼
```

**å…³é”®ç‚¹**ï¼š`df[:0]` åœ¨Pythonä¸­è¡¨ç¤º"ä»å¼€å§‹åˆ°ç´¢å¼•0ä¹‹å‰"ï¼Œå³**ä¸åŒ…å«ä»»ä½•è¡Œ**ï¼

### æ­¥éª¤3ï¼šæå–æ•°æ®

```python
# dfç°åœ¨æ˜¯ç©ºçš„ï¼Œshape = (0, 71)

extracted_data = df[input_names].values
# extracted_data.shape = (0, 25)
# æ„æ€ï¼š0è¡Œæ•°æ®ï¼Œ25åˆ—ç‰¹å¾

print(extracted_data)
# è¾“å‡º: array([], shape=(0, 25), dtype=float64)
#       ç©ºæ•°ç»„ï¼
```

### æ­¥éª¤4ï¼šè½¬æ¢ä¸ºtensor

```python
# åŸå§‹ï¼šshape = (0, 25)
tensor_data = torch.tensor(extracted_data)
print(tensor_data.shape)
# è¾“å‡º: torch.Size([0, 25])

# transpose(0, 1)ï¼šäº¤æ¢ç»´åº¦0å’Œ1
tensor_data = tensor_data.transpose(0, 1)
print(tensor_data.shape)
# è¾“å‡º: torch.Size([25, 0])  â† æ³¨æ„ï¼25å’Œ0æ¢äº†ä½ç½®

# unsqueeze(0)ï¼šåœ¨æœ€å‰é¢æ·»åŠ ä¸€ä¸ªç»´åº¦
tensor_data = tensor_data.unsqueeze(0)
print(tensor_data.shape)
# è¾“å‡º: torch.Size([1, 25, 0])  â† æœ€ç»ˆçš„é”™è¯¯å½¢çŠ¶ï¼
```

## ğŸ” ä¸ºä»€ä¹ˆæ˜¯[1, 25, 0]ï¼Ÿ

è®©æˆ‘ä»¬åˆ†è§£è¿™ä¸‰ä¸ªç»´åº¦ï¼š

```python
[1,  25,  0]
 â”‚   â”‚    â”‚
 â”‚   â”‚    â””â”€ åºåˆ—é•¿åº¦ = 0ï¼ˆæ²¡æœ‰æ—¶é—´æ­¥ï¼ï¼‰
 â”‚   â””â”€â”€â”€â”€â”€â”€ ç‰¹å¾æ•° = 25ï¼ˆæœ‰25ä¸ªä¼ æ„Ÿå™¨ç‰¹å¾ï¼‰
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ batchå¤§å° = 1ï¼ˆ1ä¸ªæ ·æœ¬ï¼‰
```

**è¿™æ˜¯ä¸€ä¸ªç©ºå®¹å™¨**ï¼š
- å‡†å¤‡å¥½äº†1ä¸ªbatch
- å‡†å¤‡å¥½äº†25ä¸ªç‰¹å¾é€šé“
- ä½†æ˜¯æ¯ä¸ªé€šé“é‡Œ**æ²¡æœ‰ä»»ä½•æ•°æ®ç‚¹**ï¼ˆé•¿åº¦ä¸º0ï¼‰

### è§†è§‰åŒ–ç†è§£

æƒ³è±¡tensoræ˜¯ä¸€ä¸ªä¸‰ç»´ç›’å­ï¼š

**æ­£å¸¸æƒ…å†µ** [1, 25, 100]ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Batch 0                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ç‰¹å¾0:  [1.2, 3.4, 5.6, ..., 100ç‚¹] â”‚ â”‚
â”‚ â”‚ ç‰¹å¾1:  [2.3, 4.5, 6.7, ..., 100ç‚¹] â”‚ â”‚
â”‚ â”‚ ç‰¹å¾2:  [3.4, 5.6, 7.8, ..., 100ç‚¹] â”‚ â”‚
â”‚ â”‚   ...                                 â”‚ â”‚
â”‚ â”‚ ç‰¹å¾24: [8.9, 0.1, 2.3, ..., 100ç‚¹] â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é”™è¯¯æƒ…å†µ** [1, 25, 0]ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Batch 0    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ç‰¹å¾0:[]â”‚ â”‚  â† ç©ºï¼æ²¡æœ‰æ•°æ®ç‚¹
â”‚ â”‚ç‰¹å¾1:[]â”‚ â”‚  â† ç©ºï¼
â”‚ â”‚ç‰¹å¾2:[]â”‚ â”‚  â† ç©ºï¼
â”‚ â”‚  ...   â”‚ â”‚
â”‚ â”‚ç‰¹å¾24:[]â”‚ â”‚ â† ç©ºï¼
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš ï¸ ä¸ºä»€ä¹ˆä¼šæŠ¥é”™ï¼Ÿ

å½“ä½ æŠŠè¿™ä¸ªç©ºtensoré€å…¥æ¨¡å‹ï¼š

```python
model = TCN(...)
output = model(input_data)  # input_data.shape = (1, 25, 0)

# æ¨¡å‹å†…éƒ¨å°è¯•åšå·ç§¯
# ä½†æ˜¯å·ç§¯éœ€è¦æœ‰æ•°æ®ç‚¹ï¼
# æ²¡æœ‰æ•°æ®ç‚¹æ€ä¹ˆå·ç§¯ï¼Ÿ

# PyTorchæŠ›å‡ºé”™è¯¯ï¼š
RuntimeError: Only zero batch or zero channel inputs are supported,
             but got input shape: [1, 25, 1, 0]
```

**ä¸ºä»€ä¹ˆé”™è¯¯ä¿¡æ¯æ˜¯[1, 25, 1, 0]è€Œä¸æ˜¯[1, 25, 0]ï¼Ÿ**

å› ä¸ºæ¨¡å‹å†…éƒ¨å¯èƒ½æœ‰æŸäº›æ“ä½œæ·»åŠ äº†é¢å¤–çš„ç»´åº¦ï¼Œä½†æ ¸å¿ƒé—®é¢˜ç›¸åŒï¼š**æœ€åä¸€ç»´æ˜¯0ï¼Œæ²¡æœ‰æ•°æ®ï¼**

## âœ… æ–°æ–¹æ³•å¦‚ä½•è§£å†³

```python
def _find_valid_range(df, columns):
    nan_mask = df[columns].isna().any(axis=1)
    valid_mask = ~nan_mask  # åè¿‡æ¥ï¼æ‰¾"ä¸å«NaN"çš„è¡Œ
    
    valid_indices = valid_mask[valid_mask].index.tolist()
    # valid_indices = [5, 6, 7, 8, 9, 10, 11, 12]
    
    start = valid_indices[0]      # 5ï¼ˆç¬¬ä¸€ä¸ªæœ‰æ•ˆè¡Œï¼‰
    end = valid_indices[-1] + 1   # 13ï¼ˆæœ€åä¸€ä¸ªæœ‰æ•ˆè¡Œ+1ï¼‰
    
    return start, end  # (5, 13)

# ä½¿ç”¨
start, end = _find_valid_range(df, input_names)
df = df.iloc[5:13]  # å–è¡Œ5åˆ°12ï¼Œå…¨æ˜¯æœ‰æ•ˆæ•°æ®ï¼

# ç°åœ¨ df.shape = (8, 71)ï¼Œæœ‰8è¡Œæ•°æ®
# æå–å extracted_data.shape = (8, 25)
# è½¬æ¢å tensor.shape = (1, 25, 8)  â† æ­£ç¡®ï¼
```

## ğŸ“ æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”

| ç»´åº¦ | æ—§æ–¹æ³•ï¼ˆé”™è¯¯ï¼‰ | æ–°æ–¹æ³•ï¼ˆæ­£ç¡®ï¼‰ |
|------|---------------|---------------|
| æ€è·¯ | æ‰¾"ç¬¬ä¸€ä¸ªNaN" | æ‰¾"æœ‰æ•ˆæ•°æ®èŒƒå›´" |
| å‡è®¾ | NaNåªåœ¨æœ«å°¾ | NaNå¯èƒ½åœ¨ä»»ä½•ä½ç½® |
| å¼€å¤´æœ‰NaN | è¿”å›0 â†’ æˆªå–df[:0] â†’ **ç©ºï¼** | è¿”å›(5,13) â†’ æˆªå–df[5:13] â†’ **æœ‰æ•°æ®** |
| æœ€ç»ˆshape | (1, 25, 0) | (1, 25, 8) |
| ç»“æœ | âŒ å´©æºƒ | âœ… æ­£å¸¸ |

## ğŸ“ å…³é”®æ•™è®­

1. **Pythonåˆ‡ç‰‡è¯­æ³•**ï¼š`df[:0]` ä¸æ˜¯"ä¿ç•™ç¬¬0è¡Œ"ï¼Œè€Œæ˜¯"ä¸€è¡Œéƒ½ä¸ä¿ç•™"
2. **ä»£ç å‡è®¾**ï¼šæ°¸è¿œä¸è¦å‡è®¾æ•°æ®æ ¼å¼ï¼Œè¦å¤„ç†æ‰€æœ‰å¯èƒ½çš„æƒ…å†µ
3. **åå‘æ€ç»´**ï¼šä¸å…¶æ‰¾"åæ•°æ®åœ¨å“ª"ï¼Œä¸å¦‚æ‰¾"å¥½æ•°æ®åœ¨å“ª"
4. **ç©ºæ•°æ®ä¼ æ’­**ï¼šä¸€æ—¦æŸä¸ªç¯èŠ‚äº§ç”Ÿç©ºæ•°æ®ï¼Œåç»­æ‰€æœ‰æ“ä½œéƒ½ä¼šä¿æŒç©ºçŠ¶æ€

## ğŸ”§ å¦‚ä½•éªŒè¯ä¿®å¤

ä¿®å¤åï¼Œä½ å¯ä»¥æ·»åŠ è°ƒè¯•ä»£ç ï¼š

```python
print(f"åŸå§‹æ•°æ®shape: {df.shape}")
start, end = self._find_valid_range(df, input_names)
print(f"æœ‰æ•ˆèŒƒå›´: [{start}:{end}]")
df = df.iloc[start:end]
print(f"æˆªå–åshape: {df.shape}")
extracted_data = df[input_names].values
print(f"æå–åshape: {extracted_data.shape}")
tensor_data = torch.tensor(extracted_data).transpose(0,1).unsqueeze(0)
print(f"æœ€ç»ˆtensor shape: {tensor_data.shape}")
```

**æœŸæœ›è¾“å‡º**ï¼ˆä¿®å¤åï¼‰ï¼š
```
åŸå§‹æ•°æ®shape: (15, 71)
æœ‰æ•ˆèŒƒå›´: [5:13]
æˆªå–åshape: (8, 71)
æå–åshape: (8, 25)
æœ€ç»ˆtensor shape: torch.Size([1, 25, 8])  â† æ­£å¸¸ï¼
```

**é”™è¯¯è¾“å‡º**ï¼ˆä¿®å¤å‰ï¼‰ï¼š
```
åŸå§‹æ•°æ®shape: (15, 71)
æœ‰æ•ˆèŒƒå›´: [0:0]  â† é—®é¢˜åœ¨è¿™ï¼
æˆªå–åshape: (0, 71)  â† ç©ºçš„ï¼
æå–åshape: (0, 25)  â† ç©ºçš„ï¼
æœ€ç»ˆtensor shape: torch.Size([1, 25, 0])  â† é”™è¯¯ï¼
```

å¸Œæœ›è¿™ä¸ªè§£é‡Šæ¸…æ¥šäº†ï¼å…³é”®å°±æ˜¯ç†è§£ `df[:0]` ä¼šäº§ç”Ÿä¸€ä¸ªç©ºçš„DataFrameã€‚